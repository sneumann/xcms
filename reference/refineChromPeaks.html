<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="The refineChromPeaks method performs a post-processing of the
chromatographic peak detection step to eventually clean and improve the
results. The function can be applied to a XcmsExperiment() or XCMSnExp()
object after peak detection with findChromPeaks(). The type of peak
refinement and cleaning can be defined, along with all its settings, using
one of the following parameter objects:
CleanPeaksParam: remove chromatographic peaks with a retention time
range larger than the provided maximal acceptable width (maxPeakwidth).
FilterIntensityParam: remove chromatographic peaks with intensities
below the specified threshold. By default (with nValues = 1) values in
the chromPeaks matrix are evaluated: all peaks with a value in the
column defined with parameter value that are &amp;gt;= a threshold (defined
with parameter threshold) are retained. If nValues is larger than 1,
the individual peak intensities from the raw MS files are evaluated:
chromatographic peaks with at least nValues mass peaks &amp;gt;= threshold
are retained.
MergeNeighboringPeaksParam: peak detection sometimes fails to identify a
chromatographic peak correctly, especially for broad peaks and if the peak
shape is irregular (mostly for HILIC data). In such cases several smaller
peaks are reported. Also, peak detection with centWave can result in
partially or completely overlapping peaks. This method aims to reduce
such peak detection artifacts by merging chromatographic peaks that are
overlapping or close in RT and m/z dimension (considering also the measured
signal between them). See section Details for MergeNeighboringPeaksParam
for details and a comprehensive description of the approach.


refineChromPeaks methods will always remove feature definitions, because
a call to this method can change or remove identified chromatographic peaks,
which may be part of features."><title>Refine Identified Chromatographic Peaks — refineChromPeaks • xcms</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Refine Identified Chromatographic Peaks — refineChromPeaks"><meta property="og:description" content="The refineChromPeaks method performs a post-processing of the
chromatographic peak detection step to eventually clean and improve the
results. The function can be applied to a XcmsExperiment() or XCMSnExp()
object after peak detection with findChromPeaks(). The type of peak
refinement and cleaning can be defined, along with all its settings, using
one of the following parameter objects:
CleanPeaksParam: remove chromatographic peaks with a retention time
range larger than the provided maximal acceptable width (maxPeakwidth).
FilterIntensityParam: remove chromatographic peaks with intensities
below the specified threshold. By default (with nValues = 1) values in
the chromPeaks matrix are evaluated: all peaks with a value in the
column defined with parameter value that are &amp;gt;= a threshold (defined
with parameter threshold) are retained. If nValues is larger than 1,
the individual peak intensities from the raw MS files are evaluated:
chromatographic peaks with at least nValues mass peaks &amp;gt;= threshold
are retained.
MergeNeighboringPeaksParam: peak detection sometimes fails to identify a
chromatographic peak correctly, especially for broad peaks and if the peak
shape is irregular (mostly for HILIC data). In such cases several smaller
peaks are reported. Also, peak detection with centWave can result in
partially or completely overlapping peaks. This method aims to reduce
such peak detection artifacts by merging chromatographic peaks that are
overlapping or close in RT and m/z dimension (considering also the measured
signal between them). See section Details for MergeNeighboringPeaksParam
for details and a comprehensive description of the approach.


refineChromPeaks methods will always remove feature definitions, because
a call to this method can change or remove identified chromatographic peaks,
which may be part of features."><meta property="og:image" content="https://sneumann.github.io/xcms/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">xcms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.99.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/xcms.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/LC-MS-feature-grouping.html">Compounding (grouping) of LC-MS features</a>
    <a class="dropdown-item" href="../articles/xcms-direct-injection.html">Grouping FTICR-MS data with xcms</a>
    <a class="dropdown-item" href="../articles/xcms-lcms-ms.html">LC-MS/MS data analysis with xcms</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/sneumann/xcms/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Refine Identified Chromatographic Peaks</h1>
      <small class="dont-index">Source: <a href="https://github.com/sneumann/xcms/blob/HEAD/R/AllGenerics.R" class="external-link"><code>R/AllGenerics.R</code></a>, <a href="https://github.com/sneumann/xcms/blob/HEAD/R/XcmsExperiment.R" class="external-link"><code>R/XcmsExperiment.R</code></a>, <a href="https://github.com/sneumann/xcms/blob/HEAD/R/functions-Params.R" class="external-link"><code>R/functions-Params.R</code></a>, and 1 more</small>
      <div class="d-none name"><code>refineChromPeaks.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The <code>refineChromPeaks</code> method performs a post-processing of the
chromatographic peak detection step to eventually clean and improve the
results. The function can be applied to a <code><a href="XcmsExperiment.html">XcmsExperiment()</a></code> or <code><a href="XCMSnExp-class.html">XCMSnExp()</a></code>
object <strong>after</strong> peak detection with <code><a href="findChromPeaks.html">findChromPeaks()</a></code>. The type of peak
refinement and cleaning can be defined, along with all its settings, using
one of the following parameter objects:</p><ul><li><p><code>CleanPeaksParam</code>: remove chromatographic peaks with a retention time
range larger than the provided maximal acceptable width (<code>maxPeakwidth</code>).</p></li>
<li><p><code>FilterIntensityParam</code>: remove chromatographic peaks with intensities
below the specified threshold. By default (with <code>nValues = 1</code>) values in
the <code>chromPeaks</code> matrix are evaluated: all peaks with a value in the
column defined with parameter <code>value</code> that are <code>&gt;=</code> a threshold (defined
with parameter <code>threshold</code>) are retained. If <code>nValues</code> is larger than 1,
the individual peak intensities from the raw MS files are evaluated:
chromatographic peaks with at least <code>nValues</code> mass peaks <code>&gt;= threshold</code>
are retained.</p></li>
<li><p><code>MergeNeighboringPeaksParam</code>: peak detection sometimes fails to identify a
chromatographic peak correctly, especially for broad peaks and if the peak
shape is irregular (mostly for HILIC data). In such cases several smaller
peaks are reported. Also, peak detection with <em>centWave</em> can result in
partially or completely overlapping peaks. This method aims to reduce
such peak detection artifacts by merging chromatographic peaks that are
overlapping or close in RT and m/z dimension (considering also the measured
signal between them). See section <em>Details for MergeNeighboringPeaksParam</em>
for details and a comprehensive description of the approach.</p></li>
</ul><p><code>refineChromPeaks</code> methods will always remove feature definitions, because
a call to this method can change or remove identified chromatographic peaks,
which may be part of features.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">object</span>, <span class="va">param</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XcmsExperiment,CleanPeaksParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">object</span>, param <span class="op">=</span> <span class="fu">CleanPeaksParam</span><span class="op">(</span><span class="op">)</span>, msLevel <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XcmsExperiment,MergeNeighboringPeaksParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">param</span>,</span>
<span>  msLevel <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  chunkSize <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XcmsExperiment,FilterIntensityParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">param</span>,</span>
<span>  msLevel <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  chunkSize <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">CleanPeaksParam</span><span class="op">(</span>maxPeakwidth <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">MergeNeighboringPeaksParam</span><span class="op">(</span></span>
<span>  expandRt <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  expandMz <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  minProp <span class="op">=</span> <span class="fl">0.75</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">FilterIntensityParam</span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">0</span>, nValues <span class="op">=</span> <span class="fl">1L</span>, value <span class="op">=</span> <span class="st">"maxo"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XCMSnExp,CleanPeaksParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">object</span>, param <span class="op">=</span> <span class="fu">CleanPeaksParam</span><span class="op">(</span><span class="op">)</span>, msLevel <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XCMSnExp,MergeNeighboringPeaksParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  param <span class="op">=</span> <span class="fu">MergeNeighboringPeaksParam</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  msLevel <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for XCMSnExp,FilterIntensityParam</span></span>
<span><span class="fu">refineChromPeaks</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  param <span class="op">=</span> <span class="fu">FilterIntensityParam</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  msLevel <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>object</dt>
<dd><p><a href="XCMSnExp-class.html">XCMSnExp</a> or <a href="XcmsExperiment.html">XcmsExperiment</a> object with identified
chromatographic peaks.</p></dd>


<dt>param</dt>
<dd><p>Object defining the refinement method and its settings.</p></dd>


<dt>...</dt>
<dd><p>ignored.</p></dd>


<dt>msLevel</dt>
<dd><p><code>integer</code> defining for which MS level(s) the chromatographic
peaks should be cleaned.</p></dd>


<dt>chunkSize</dt>
<dd><p>For <code>refineChromPeaks</code> if <code>object</code> is either an
<code>XcmsExperiment</code>: <code>integer(1)</code> defining the number of files (samples)
that should be loaded into memory and processed at the same time.
Peak refinement is then performed in parallel (per sample) on this subset
data. This setting thus allows to balance between memory
demand and speed (due to parallel processing). Because parallel
processing can only performed on the subset of data currently loaded
into memory in each iteration, the value for <code>chunkSize</code> should match
the defined  parallel setting setup. Using a parallel processing setup
using 4 CPUs (separate processes) but using <code>chunkSize = </code>1<code>will not perform any parallel processing, as only the data from one sample is loaded in memory at a time. On the other hand, setting</code>chunkSize` to
the total number of samples in an experiment will load the full MS data
into memory and will thus in most settings cause an out-of-memory error.</p></dd>


<dt>BPPARAM</dt>
<dd><p>parameter object to set up parallel processing. Uses the
default parallel processing setup returned by <code><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam()</a></code>. See
<code><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam()</a></code> for details and examples.</p></dd>


<dt>maxPeakwidth</dt>
<dd><p>For <code>CleanPeaksParam</code>: <code>numeric(1)</code> defining the maximal
allowed peak width (in retention time).</p></dd>


<dt>expandRt</dt>
<dd><p>For <code>MergeNeighboringPeaksParam</code>: <code>numeric(1)</code> defining by
how many seconds the retention time window is expanded on both sides to
check for overlapping peaks.</p></dd>


<dt>expandMz</dt>
<dd><p>For <code>MergeNeighboringPeaksParam</code>: <code>numeric(1)</code> constant
value by which the m/z range of each chromatographic peak is expanded
(on both sides!) to check for overlapping peaks.</p></dd>


<dt>ppm</dt>
<dd><p>For <code>MergeNeighboringPeaksParam</code>: <code>numeric(1)</code> defining a m/z
relative value (in parts per million) by which the m/z range of each
chromatographic peak is expanded to check for overlapping peaks.</p></dd>


<dt>minProp</dt>
<dd><p>For <code>MergeNeighboringPeaksParam</code>: <code>numeric(1)</code> between <code>0</code>
and <code>1</code> representing the proporion of intensity required for peaks to be
joined. See description for more details. With default (<code>minProp = 0.75</code>)
only peaks are joined if the signal half way between them is larger than
75% of the smallest of the two peak's <code>"maxo"</code> (maximal intensity at
peak apex).</p></dd>


<dt>threshold</dt>
<dd><p>For <code>FilterIntensityParam</code>: <code>numeric(1)</code> defining the
threshold below which peaks are removed.</p></dd>


<dt>nValues</dt>
<dd><p>For <code>FilterIntensityParam</code>: <code>integer(1)</code> defining the number
of data points (for each chromatographic peak) that have to be
<code>&gt;= threshold</code>. Defaults to <code>nValues = 1</code>.</p></dd>


<dt>value</dt>
<dd><p>For <code>FilterIntensityParam</code>: <code>character(1)</code> defining the name
of the column in <code>chromPeaks</code> that contains the values to be used for
the filtering.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p><code>XCMSnExp</code> or <a href="XcmsExperiment.html">XcmsExperiment</a> object with the refined
chomatographic peaks.</p>
    </div>
    <div class="section level2">
    <h2 id="details-for-mergeneighboringpeaksparam">Details for MergeNeighboringPeaksParam<a class="anchor" aria-label="anchor" href="#details-for-mergeneighboringpeaksparam"></a></h2>
    


<p>For peak refinement using the <code>MergeNeighboringPeaksParam</code>, chromatographic
peaks are first expanded in m/z and retention time dimension (based on
parameters <code>expandMz</code>, <code>ppm</code> and <code>expandRt</code>) and subsequently grouped into
sets of merge candidates if they are (after expansion) overlapping in both
m/z and rt (within the <strong>same</strong> sample). Note that <strong>each</strong> peak gets
expanded by <code>expandRt</code> and <code>expandMz</code>, thus peaks differing by less than
<code>2 * expandMz</code> (or <code>2 * expandRt</code>) will be evaluated for merging.
Peak merging is performed along the retention time axis, i.e., the peaks are
first ordered by their <code>"rtmin"</code> and merge candidates are defined iteratively
starting with the first peak.
Candidate peaks are merged if the
average intensity of the 3 data points in the middle position between them
(i.e., at half the distance between <code>"rtmax"</code> of the first and <code>"rtmin"</code> of
the second peak) is larger than a certain proportion (<code>minProp</code>) of the
smaller (<code>"maxo"</code>) intensity of both peaks. In cases in which this calculated
mid point is not located between the apexes of the two peaks (e.g., if the
peaks are largely overlapping) the average signal intensity at half way
between the apexes is used instead. Candidate peaks are not merged if all 3
data points between them have <code>NA</code> intensities.</p>
<p>Merged peaks get the <code>"mz"</code>, <code>"rt"</code>, <code>"sn"</code> and <code>"maxo"</code> values from the
peak with the largest signal (<code>"maxo"</code>) as well as its row in the metadata
of the peak (<code>chromPeakData</code>). The <code>"rtmin"</code> and <code>"rtmax"</code> of the merged
peaks are updated and <code>"into"</code> is recalculated based on all signal between
<code>"rtmin"</code> and <code>"rtmax"</code> and the newly defined <code>"mzmin"</code> and <code>"mzmax"</code> (which
is the range of <code>"mzmin"</code> and <code>"mzmax"</code> of the merged peaks after expanding
by <code>expandMz</code> and <code>ppm</code>). The reported <code>"mzmin"</code> and <code>"mzmax"</code> for the
merged peak represents the m/z range of all non-NA intensities used for the
calculation of the peak signal (<code>"into"</code>).</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Johannes Rainer, Mar Garcia-Aloy</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Load a test data set with detected peaks</span></span></span>
<span class="r-in"><span><span class="va">faahko_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="loadXcmsData.html">loadXcmsData</a></span><span class="op">(</span><span class="st">"faahko_sub2"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Disable parallel processing for this example</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">####</span></span></span>
<span class="r-in"><span><span class="co">## CleanPeaksParam:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Distribution of chromatographic peak widths</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">faahko_sub</span><span class="op">)</span><span class="op">[</span>, <span class="st">"rtmax"</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">faahko_sub</span><span class="op">)</span><span class="op">[</span>, <span class="st">"rtmin"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      0%     25%     50%     75%    100% </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   6.259  29.734  43.819  57.903 173.710 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Remove all chromatographic peaks with a width larger 60 seconds</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">faahko_sub</span>, param <span class="op">=</span> <span class="fu">CleanPeaksParam</span><span class="op">(</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Removed 54 of 248 chromatographic peaks.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>, <span class="st">"rtmax"</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>, <span class="st">"rtmin"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     0%    25%    50%    75%   100% </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  6.259 23.475 39.906 46.949 59.469 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">####</span></span></span>
<span class="r-in"><span><span class="co">## FilterIntensityParam:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Remove all peaks with a maximal intensity below 50000</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">faahko_sub</span>,</span></span>
<span class="r-in"><span>    param <span class="op">=</span> <span class="fu">FilterIntensityParam</span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reduced from 248 to 155 chromatographic peaks.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">faahko_sub</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 248</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 155</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">####</span></span></span>
<span class="r-in"><span><span class="co">## MergeNeighboringPeaksParam:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Subset to a single file</span></span></span>
<span class="r-in"><span><span class="va">xd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lgatto.github.io/MSnbase/reference/MSnExp-class.html" class="external-link">filterFile</a></span><span class="op">(</span><span class="va">faahko_sub</span>, file <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Example of a split peak that will be merged</span></span></span>
<span class="r-in"><span><span class="va">mzr</span> <span class="op">&lt;-</span> <span class="fl">305.1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-method.html">chromatogram</a></span><span class="op">(</span><span class="va">xd</span>, mz <span class="op">=</span> <span class="va">mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2700</span>, <span class="fl">3700</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">chr</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="refineChromPeaks-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Combine the peaks</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">refineChromPeaks</span><span class="op">(</span><span class="va">xd</span>, param <span class="op">=</span> <span class="fu">MergeNeighboringPeaksParam</span><span class="op">(</span>expandRt <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reduced from 87 to 70 chromatographic peaks.</span>
<span class="r-in"><span><span class="va">chr_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-method.html">chromatogram</a></span><span class="op">(</span><span class="va">res</span>, mz <span class="op">=</span> <span class="va">mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2700</span>, <span class="fl">3700</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">chr_res</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="refineChromPeaks-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Example of a peak that was not merged, because the signal between them</span></span></span>
<span class="r-in"><span><span class="co">## is lower than the cut-off minProp</span></span></span>
<span class="r-in"><span><span class="va">mzr</span> <span class="op">&lt;-</span> <span class="fl">496.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-method.html">chromatogram</a></span><span class="op">(</span><span class="va">xd</span>, mz <span class="op">=</span> <span class="va">mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3200</span>, <span class="fl">3500</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">chr</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">chr_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-method.html">chromatogram</a></span><span class="op">(</span><span class="va">res</span>, mz <span class="op">=</span> <span class="va">mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3200</span>, <span class="fl">3500</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">chr_res</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="refineChromPeaks-3.png" alt="" width="700" height="433"></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Colin A. Smith, Ralf Tautenhahn, Steffen Neumann, Paul Benton, Christopher Conley, Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer></div>

  

  

  </body></html>

